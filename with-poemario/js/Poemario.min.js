if(typeof jQuery==="undefined"){var script=document.createElement("script");script.src="http://code.jquery.com/jquery-latest.min.js";script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script)}function Poemario(first_mode,flow_mode,type_mode,poem_speed,type_speed,list_poems,top_pixels,has_audio,sounds_origin){const RUNNING=1;const GRACEFUL=2;const STATEFUL=3;var DEBUG=false;var w_height=0;var w_width=0;var timers=new Array;var saved_state=new Array;var txt_running=undefined;var snd_running=undefined;var audio1=undefined;var audio2=undefined;var audio_func1=undefined;var audio_func2=undefined;var audio_tmr1=undefined;var audio_tmr2=undefined;var snd_arr_a=undefined;var snd_arr_b=undefined;var snd_freq=2e3;var _firstp,_flow_mode,_type_mode,_poem_speed,_type_speed,_num_poems,_list_poems,_top_pixels,_has_audio,_sounds_origin;typeof first_mode==="undefined"?_first_mode=1:_first_mode=first_mode;typeof flow_mode==="undefined"?_flow_mode=2:_flow_mode=flow_mode;typeof type_mode==="undefined"?_type_mode=2:_type_mode=type_mode;typeof poem_speed==="undefined"?_poem_speed=100:_poem_speed=poem_speed;typeof type_speed==="undefined"?_type_speed=100:_type_speed=type_speed;typeof list_poems==="undefined"?_list_poems=["poem1.xml"]:_list_poems=list_poems;typeof top_pixels==="undefined"?_top_pixels=0:_top_pixels=top_pixels;typeof has_audio==="undefined"?_has_audio=false:_has_audio=has_audio;_sounds_origin=sounds_origin;_num_poems=_list_poems.length;Object.defineProperty(Poemario.prototype,"flow_mode",{configurable:true,get:function(){return _flow_mode},set:function(newval){_flow_mode=newval}});Object.defineProperty(Poemario.prototype,"type_mode",{configurable:true,get:function(){return _type_mode},set:function(newval){_type_mode=newval}});Object.defineProperty(Poemario.prototype,"poem_speed",{configurable:true,get:function(){return _poem_speed},set:function(newval){_poem_speed=newval}});Object.defineProperty(Poemario.prototype,"type_speed",{configurable:true,get:function(){return _type_speed},set:function(newval){_type_speed=newval}});Object.defineProperty(Poemario.prototype,"top_pixels",{configurable:true,get:function(){return _top_pixels},set:function(newval){_top_pixels=newval}});Poemario.prototype.all_stop=function(){if(txt_running!==undefined){stop_all_timers();$("p").remove()}if(_has_audio){if(snd_running!==undefined){if(DEBUG)console.log("AUDIO ALL: stopping...");audio1.removeEventListener("ended",audio_func1,false);audio2.removeEventListener("ended",audio_func2,false);if(audio_tmr1!==undefined)clearTimeout(audio_tmr1);if(audio_tmr2!==undefined)clearTimeout(audio_tmr2);audio1.pause();audio2.pause();delete audio1;delete audio2;snd_running=undefined;if(DEBUG)console.log("... now")}}};Poemario.prototype.txt_start=function(){if(txt_running===undefined){txt_running=RUNNING;$("head").append($('<link rel="stylesheet" type="text/css" />').attr("href","css/Poemario.css"));$("#body").append('<div id="free-top"></div>');for(i=1;i<=_num_poems+1;i++){$("#body").append('<div class="container" id="container'+String(i)+'" style="overflow-y: scroll;"></div>');timers.push(0);timers.push(0);window["block_counter"+i]=0;go_poem(String(i),new Array,new Array,timers.length-2,timers.length-1,true)}}};Poemario.prototype.txt_stop_graceful=function(){if(txt_running!==undefined)if(txt_running==RUNNING)txt_running=GRACEFUL};Poemario.prototype.txt_stop_stateful=function(){if(txt_running!==undefined)if(txt_running==RUNNING)txt_running=STATEFUL};Poemario.prototype.txt_resume=function(){if(txt_running!==undefined){if(txt_running==GRACEFUL){txt_running=RUNNING;for(i=1;i<=_num_poems;i++)go_poem(String(i),new Array,new Array,i*2-2,i*2-1,false)}if(txt_running==STATEFUL){txt_running=RUNNING;resume_stateful()}}};Poemario.prototype.txt_reset=function(){if(txt_running!==undefined){stop_all_timers();$("p").remove();txt_running=RUNNING;for(i=1;i<=_num_poems;i++)go_poem(String(i),new Array,new Array,i*2-2,i*2-1,true)}};Poemario.prototype.audio_start=function(frequency){if(_has_audio){if(snd_running!==undefined){if(snd_running!=RUNNING){snd_freq=frequency;go_audio();snd_running=RUNNING}}}};Poemario.prototype.audio_stop=function(stop_now){if(_has_audio){if(typeof stop_now==="undefined")stop_now=true;if(snd_running!==undefined){if(DEBUG)console.log("AUDIO ALL: stopping...");if(snd_running==RUNNING){if(stop_now){if(DEBUG)console.log("... now");audio1.pause();audio2.pause();snd_running=STATEFUL}else{if(DEBUG)console.log("... later");audio1.removeEventListener("ended",audio_func1,false);audio2.removeEventListener("ended",audio_func2,false);snd_running=GRACEFUL}}}}};Poemario.prototype.audio_resume=function(){if(_has_audio){if(snd_running!==undefined){if(snd_running!=RUNNING){if(DEBUG)console.log("AUDIO ALL: resuming");if(snd_running==STATEFUL){audio1.play();audio2.play()}else{audio1.addEventListener("ended",audio_func1=function(){audio_again(1)},false);audio2.addEventListener("ended",audio_func2=function(){audio_again(2)},false);audio_again(1);audio_again(2)}snd_running=RUNNING}}}};function go_poem(pnum,poem,live,id_timer1,id_timer2,reset){$.ajax({type:"GET",url:_list_poems[parseInt(pnum)-1],dataType:"xml",success:function(xml){var $parsed=$(xml);var $texto=$parsed.find("texto");$texto.each(function(){var $entry=$(this);var verso=$entry.attr("verso");var ordem=$entry.attr("ordem");var taxon=$entry.attr("taxon");poem.push(new Array(verso,ordem,taxon));live.push(new Array(verso,0))});var $cats=$parsed.find("categorias");$cats.contents().each(function(i,el){if(el.nodeType==1){$element=$parsed.find(el.nodeName);window[el.nodeName]=new Array;$element.contents().each(function(){var $elem=$(this);elem=$.trim($elem.text());if(elem.length>0)window[el.nodeName].push(elem)})}});var $audio=$parsed.find("audio");$audio.contents().each(function(i,el){if(el.nodeType==1){$element=$parsed.find(el.nodeName);window[el.nodeName]=new Array;$element.contents().each(function(){var $elem=$(this);elem=$.trim($elem.text());if(elem.length>0)window[el.nodeName].push(elem)})}});for(var i=0;i<poem.length;i++){live[i][0]=count_initial_spaces(poem[i][0]);live[i][1]=poem[i][0]}if(reset){resize_window(null,pnum,live);$(window).bind("resize",resize_window(null,pnum,live));window["block_counter"+pnum]=window["block_counter"+pnum]+1;if(_first_mode!=1){for(var i=0;i<live.length;i++){add_vers(new Array(live[i][0]," "),pnum,i)}first_poem(poem,live,pnum,0,0,id_timer1,id_timer2)}else{for(var i=0;i<live.length;i++){add_vers(new Array(live[i][0],live[i][1]),pnum,i)}timers[id_timer1]=setTimeout(main_task(poem,live,pnum,0,id_timer1,id_timer2),_poem_speed)}}else{timers[id_timer1]=setTimeout(main_task(poem,live,pnum,0,id_timer1,id_timer2),_poem_speed)}if(_has_audio){if(snd_running===undefined){typeof _sounds_origin!=="undefined"?snd_arr_a=create_array_from_url_sync(_sounds_origin+"/sndsa_index.txt"):snd_arr_a=window["snds_a"];typeof _sounds_origin!=="undefined"?snd_arr_b=create_array_from_url_sync(_sounds_origin+"/sndsb_index.txt"):snd_arr_b=window["snds_b"];audio1=document.createElement("audio");audio2=document.createElement("audio");$("#audio1").loop=false;$("#audio2").loop=false;$("#audio1").volume=.5;$("#audio2").volume=.5;snd_running=GRACEFUL}}}})}function first_poem(poem,live,pnum,lnum,typing_pos,id_timer1,id_timer2){if(txt_running==STATEFUL){saved_state.push(first_poem);saved_state.push([poem,live,pnum,lnum,typing_pos,id_timer1,id_timer2]);stop_pnum_timers(id_timer1,id_timer2);return}if(_type_mode==1){if(lnum>=live.length-1){clearTimeout(timers[id_timer2]);if(_flow_mode==1)set_vers(live[lnum][1],pnum,lnum);else add_vers(live[lnum],pnum,lnum);timers[id_timer1]=setTimeout(function(){main_task(poem,live,pnum,0,id_timer1,id_timer2)},_poem_speed)}else{if(_flow_mode==1)set_vers(live[lnum][1],pnum,lnum);else add_vers(live[lnum],pnum,lnum);timers[id_timer2]=setTimeout(function(){first_poem(poem,live,pnum,lnum+1,typing_pos,id_timer1,id_timer2)},_poem_speed)}}else typing_task(poem,live,pnum,0,0,id_timer1,id_timer2,true)}function stop_all_timers(){for(var i=0;i<timers.length;i++)clearTimeout(timers[i])}function stop_pnum_timers(id_tmr1,id_tmr2){clearTimeout(id_tmr1);clearTimeout(id_tmr2)}function resume_stateful(){if(saved_state.length>0){for(var i=0;i<saved_state.length;i+=2){saved_state[i].apply(this,saved_state[i+1])}saved_state=[]}}function main_task(poem,live,pnum,typing_pos,id_timer1,id_timer2){if(txt_running==GRACEFUL)return;if(txt_running==STATEFUL){saved_state.push(main_task);saved_state.push([poem,live,pnum,typing_pos,id_timer1,id_timer2]);stop_pnum_timers(id_timer1,id_timer2);return}if(_flow_mode==1){i=Math.floor(Math.random()*live.length);var empty_space=count_initial_spaces(poem[i][0]);var words=poem[i][0].trim().split(" ");var orders=poem[i][1].split(",");var taxons=poem[i][2].split(",");live[i][0]=empty_space;var j=Math.floor(Math.random()*orders.length);var taxons_list=window[taxons[j]];if(orders[0].length>0&&taxons[0].length>0){words[orders[j]-1]=taxons_list[Math.floor(Math.random()*taxons_list.length)];live[i][1]=words.join(" ")}else live[i][1]=poem[i][0]}else{for(i=0;i<poem.length;i++){var empty_space=count_initial_spaces(poem[i][0]);var words=poem[i][0].trim().split(" ");var orders=poem[i][1].split(",");var taxons=poem[i][2].split(",");if(orders[0].trim().length>0&&taxons[0].trim().length>0){for(j=0;j<orders.length;j++){var taxons_list=window[taxons[j]];words[orders[j]-1]=taxons_list[Math.floor(Math.random()*taxons_list.length)]}}live[i][0]=empty_space;live[i][1]=words.join(" ")}}if(_flow_mode==1&&_type_mode==1){set_vers(live[i][1],pnum,i);timers[id_timer1]=setTimeout(function(){main_task(poem,live,pnum,typing_pos,id_timer1,id_timer2)},_poem_speed)}else if(_flow_mode!=1&&_type_mode==1){window["block_counter"+pnum]=window["block_counter"+pnum]+1;for(i=0;i<live.length;i++){add_vers(live[i],pnum,i)}timers[id_timer1]=setTimeout(function(){main_task(poem,live,pnum,typing_pos,id_timer1,id_timer2)},_poem_speed)}else{clearTimeout(timers[id_timer1]);typing_pos=0;if(_flow_mode==1){set_vers("",pnum,i);timers[id_timer2]=setTimeout(function(){typing_task(poem,live,pnum,i,typing_pos,id_timer1,id_timer2,false)},_type_speed)}else{window["block_counter"+pnum]=window["block_counter"+pnum]+1;for(i=0;i<live.length;i++){add_vers(new Array(live[i][0]," "),pnum,i)}timers[id_timer2]=setTimeout(function(){typing_task(poem,live,pnum,0,typing_pos,id_timer1,id_timer2,false)},_type_speed)}}}function typing_task(poem,live,pnum,lnum,typing_pos,id_timer1,id_timer2,is_initial){if(txt_running==STATEFUL){saved_state.push(typing_task);saved_state.push([poem,live,pnum,lnum,typing_pos,id_timer1,id_timer2,is_initial]);stop_pnum_timers(id_timer1,id_timer2);return}partial=live[lnum][1].substr(0,++typing_pos);if(lnum>=live.length-1&&typing_pos>live[lnum][1].length||typing_pos>live[lnum][1].length&&_flow_mode==1){if(is_initial&&lnum<live.length-1){if(live[lnum][1].length==0)set_vers("",pnum,lnum);timers[id_timer2]=setTimeout(function(){typing_task(poem,live,pnum,lnum+1,0,id_timer1,id_timer2,is_initial)},_poem_speed)}else{clearTimeout(timers[id_timer2]);set_vers(partial,pnum,lnum);timers[id_timer1]=setTimeout(function(){main_task(poem,live,pnum,0,id_timer1,id_timer2)},_poem_speed)}}else{if(typing_pos<=live[lnum][1].length){set_vers(partial,pnum,lnum);timers[id_timer2]=setTimeout(function(){typing_task(poem,live,pnum,lnum,typing_pos,id_timer1,id_timer2,is_initial)},_type_speed)}else{if(live[lnum][1].length==0)set_vers("",pnum,lnum);timers[id_timer2]=setTimeout(function(){typing_task(poem,live,pnum,lnum+1,0,id_timer1,id_timer2,is_initial)},_type_speed)}}}function bold_some(line){var sentences=line.split(".");if(sentences.length>2){var idx=Math.floor(Math.random()*sentences.length);sentences[idx]="<b>"+sentences[idx]+"</b>"}return sentences.join(".")}function set_vers(line,pnum,lnum){if(line.length>0){var clean_line=line.replace(/_/g," ");clean_line=bold_some(clean_line);$("#pvers"+pnum+"-"+String(window["block_counter"+pnum])+"-"+String(lnum)).html(clean_line);if(line.length==1)scroll_bottom("#container"+pnum)}else $("#pvers"+pnum+"-"+String(window["block_counter"+pnum])+"-"+String(lnum)).html("<BR>")}function add_vers(arr,pnum,lnum){$("#container"+pnum).append('<p id="pvers'+pnum+"-"+String(window["block_counter"+pnum])+"-"+String(lnum)+'" style="text-indent: '+arr[0]+'em;" class="vers"></p>');set_vers(String(arr[1]),pnum,lnum);scroll_bottom("#container"+pnum)}function scroll_bottom(container){var scr=$(container)[0].scrollHeight;$(container).scrollTop(scr);if(DEBUG)console.log("scroll height is "+scr+" and scrolltop is "+$(container).scrollTop())}function resize_window(e,pnum,live){w_height=$(window).height();w_width=$(window).width();$("#free-top").height(_top_pixels)+"px";$("#free-top").width(w_width)+"px";$("#free-top").parent().css({position:"relative"});$("#free-top").css({top:1,left:1,position:"absolute","z-index":"1"});$("#container"+pnum).height(w_height-_top_pixels)+"px";$("#container"+pnum).width(w_width/_num_poems)+"px";$("#container"+pnum).parent().css({position:"relative"});$("#container"+pnum).css({top:1+top_pixels,left:(pnum-1)*(w_width/_num_poems),position:"absolute","z-index":"1"});scroll_bottom("#container"+pnum)}function count_initial_spaces(str){var res=0;for(var i=0;i<str.length;i++){if(str.charAt(i)==" ")res++;else break}return res}function empty_string(len){len=Number(len);var str="";for(var i=0;i<len;i++)str+=" ";return str}function go_audio(){if(DEBUG)console.log("AUDIO ALL: starting from scratch");snds_idx=Math.floor(Math.random()*snd_arr_a.length);audio1.setAttribute("src",snd_arr_a[snds_idx]);audio1.addEventListener("canplay",function(){if(snd_running==RUNNING){if(DEBUG)console.log("AUDIO1: playing new");audio1.play()}},false);audio1.addEventListener("ended",audio_func1=function(){audio_again(1)},false);snds_idx=Math.floor(Math.random()*snd_arr_b.length);audio2.setAttribute("src",snd_arr_b[snds_idx]);audio2.addEventListener("canplay",function(){if(snd_running==RUNNING){if(DEBUG)console.log("AUDIO2: playing new");audio2.play()}},false);audio2.addEventListener("ended",audio_func2=function(){audio_again(2)},false);audio1.load();audio2.load()}function audio_again(id){switch(id){case 1:if(DEBUG)console.log("AUDIO1: rescheduling");audio_tmr1=setTimeout(function(){snds_idx=Math.floor(Math.random()*snd_arr_a.length);audio1.setAttribute("src",snd_arr_a[snds_idx]);if(DEBUG)console.log("AUDIO1: loading new");audio1.load()},snd_freq);break;case 2:if(DEBUG)console.log("AUDIO2: rescheduling");audio_tmr2=setTimeout(function(){snds_idx=Math.floor(Math.random()*snd_arr_b.length);audio2.setAttribute("src",snd_arr_b[snds_idx]);if(DEBUG)console.log("AUDIO2: loading new");audio2.load()},snd_freq);break;default:console.log("weird thing happened in audio land!");break}}function create_array_from_url_sync(src_url){var txt_array=[];var txt_url=new XMLHttpRequest;txt_url.open("GET",src_url,false);txt_url.send();txt_string=txt_url.responseText;txt_array=txt_string.split(/\r\n|\n/);if(txt_array[txt_array.length-1]==""){txt_array.pop()}return txt_array}}